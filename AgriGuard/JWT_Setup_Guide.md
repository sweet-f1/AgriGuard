# 和风天气JWT认证设置指南

## 🎯 你已选择JWT认证 - 更安全的方式！

由于你选择了JWT认证，请按以下步骤完成配置：

## 📋 所需信息
在开始之前，你需要准备：
- 和风天气开发者账号
- 终端/命令行工具
- 文本编辑器

## 🚀 详细步骤

### 第一步：生成Ed25519密钥对

打开终端，运行以下命令：

```bash
# 生成私钥和公钥
openssl genpkey -algorithm ED25519 -out ed25519-private.pem && openssl pkey -pubout -in ed25519-private.pem > ed25519-public.pem

# 查看生成的文件
ls -la ed25519-*.pem
```

你应该看到两个文件：
- `ed25519-private.pem` (私钥，保密)
- `ed25519-public.pem` (公钥，需要上传)

### 第二步：上传公钥到和风天气

1. 登录 [和风天气控制台](https://dev.qweather.com/)
2. 进入"项目管理"
3. 选择你的项目或创建新项目
4. 点击"添加凭据"按钮
5. 选择"JSON Web Token"认证方式
6. 输入凭据名称（例如：AgriGuard-JWT）
7. 打开 `ed25519-public.pem` 文件，复制全部内容到公钥文本框
8. 点击"保存"

### 第三步：记录关键信息

保存后，和风天气会显示：
- **凭据ID** (这就是你需要的 keyId)
- **项目ID** (这就是你需要的 projectId)
- **SHA256值** (用于验证公钥)

### 第四步：配置应用

打开 `WeatherConfig.swift` 文件，填入以下信息：

```swift
// 从第三步获取的信息
static let projectId = "你的项目ID"        // 例如：HE2309281234567890
static let keyId = "你的凭据ID"          // 例如：ABCD1234EFGH5678

// 从 ed25519-private.pem 文件复制的内容
static let privateKey = """
-----BEGIN PRIVATE KEY-----
这里粘贴你的私钥内容
每一行都要完整复制，包括开头和结尾的标记
-----END PRIVATE KEY-----
"""
```

### 第五步：验证配置

1. 重新运行应用
2. 点击导航栏右上角的天气图标
3. 查看Xcode控制台的日志：

**成功的日志应该显示：**
```
开始生成JWT token...
项目ID: HE2309281234567890
密钥ID: ABCD1234EFGH5678
✅ 私钥解析成功，长度: 32 字节
✅ Ed25519私钥加载成功
✅ JWT生成成功，长度: xxx
使用JWT认证
```

**如果有错误，可能会看到：**
```
❌ 私钥解析失败，请检查privateKey格式
❌ JWT生成失败: xxxxx
```

## 🔧 常见问题

### Q: 私钥解析失败怎么办？
A: 检查以下几点：
- 确保完整复制了私钥内容，包括 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`
- 确保没有多余的空格或字符
- 确保使用的是Ed25519算法生成的密钥

### Q: 网络请求失败怎么办？
A: 检查以下几点：
- 确保项目ID和密钥ID正确
- 确保网络连接正常
- 检查和风天气服务状态

### Q: API返回认证错误怎么办？
A: 可能的原因：
- JWT token格式不正确
- 密钥ID与上传的公钥不匹配
- token已过期（应用会自动生成新的）

## 🔒 安全提醒

- ⚠️ **不要将私钥文件提交到代码仓库**
- ⚠️ **不要在公共场所分享私钥内容**
- ✅ 可以将 `WeatherConfig.swift` 添加到 `.gitignore`
- ✅ 生产环境建议使用Keychain存储私钥

## 🎉 配置完成

配置成功后，你的应用就能：
- 安全地获取实时天气数据
- 显示详细的天气信息
- 享受JWT认证的高安全性

有问题？检查Xcode控制台的详细日志信息！ 